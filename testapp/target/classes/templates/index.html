<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #333; }
        .menu { text-align: center; margin: 30px 0; }
        .menu button {
            margin: 0 8px;
            padding: 10px 16px;
            font-weight: bold;
            font-size: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .menu button:hover { background: #0056b3; }
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        .form-group { margin: 15px 0; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        input { padding: 8px; width: 350px; border: 1px solid #ccc; border-radius: 4px; }
        button:not(.menu button) {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
        button:not(.menu button):hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background: #f8f9fa; }
    </style>
</head>
<body>
<div class="container">
    <h1>Product Management System</h1>

    <div class="menu">
        <button onclick="showSection('add')">Add Product</button>
        <button onclick="showSection('delete')">Delete Product</button>
        <button onclick="showSection('showAllProducts')">Show Products</button>
        <button onclick="showSection('findById')">Find by ID</button>
        <button onclick="showSection('findByName')">Find by Name</button>
        <button onclick="showSection('updatePriceSection')">Update price</button> </div>

    <div class="content">
        <div id="add" class="section hidden">
            <h2>Add Product</h2>
            <div class="form-group"><label>Product Name:</label><input type="text" id="addName"></div>
            <div class="form-group"><label>Price:</label><input type="number" step="0.01" id="addPrice"></div>
            <div class="form-group"><label>Category:</label><input type="text" id="addCategory"></div>
            <div class="form-group"><label>Stock:</label><input type="number" id="addStock"></div>
            <button onclick="addProduct()">Add Product</button>
        </div>

        <div id="delete" class="section hidden">
            <h2>Delete Product</h2>
            <div class="form-group"><label>Product ID:</label><input type="number" id="deleteId"></div>
            <button onclick="deleteProduct()">Delete Product</button>
        </div>

        <div id="showAllProducts" class="section hidden">
            <h2>All Products</h2>
            <button onclick="loadAllProducts()">Load Products</button>
            <div id="productsList"></div>
        </div>

        <div id="findById" class="section hidden">
            <h2>Find Product by ID</h2>
            <div class="form-group"><label>Product ID:</label><input type="number" id="searchId"></div>
            <button onclick="findProductById()">Search</button>
            <div id="searchResultId"></div>
        </div>

        <div id="findByName" class="section hidden">
            <h2>Find Product by Name</h2>
            <div class="form-group"><label>Product Name:</label><input type="text" id="searchName"></div>
            <button onclick="findProductByName()">Search</button>
            <div id="searchResultName"></div>
        </div>
        
        <div id="updatePriceSection" class="section hidden">
            <h2>Update Product Price</h2>
            <div class="form-group">
                <label>Product ID:</label>
                <input type="number" id="updateId" placeholder="ID to update">
            </div>
            <div class="form-group">
                <label>New Price:</label>
                <input type="number" step="0.01" id="newPrice" placeholder="Enter new price">
            </div>
            <button onclick="updatePrice()">Update Price</button>
        </div>
        
        <div id="fullUpdateForm" class="section hidden">
            <h2>Edit Product</h2>

            <input type="hidden" id="editProductId">

            <div class="form-group">
                <label>Product Name:</label>
                <input type="text" id="editProductName" required>
            </div>

            <div class="form-group">
                <label>Price ($):</label>
                <input type="number" step="0.01" id="editProductPrice" required>
            </div>

            <div class="form-group">
                <label>Category:</label>
                <input type="text" id="editProductCategory">
            </div>

            <div class="form-group">
                <label>Stock:</label>
                <input type="number" id="editProductStock">
            </div>

            <div style="margin-top: 20px;">
                <button onclick="saveFullProductUpdate()">Save Changes</button>
                <button onclick="cancelFullUpdate()" style="background:#dc3545;">Cancel</button>
            </div>
        </div>
        
    </div>
</div>

<script>
    function showSection(sectionId) {
        document.getElementById('fullUpdateForm').classList.add('hidden');
        
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
    }

    async function loadAllProducts() {
        const container = document.getElementById('productsList');
        const button = container.previousElementSibling;

        button.disabled = true;
        button.textContent = 'Loading...';
        container.innerHTML = '<p>Loading products...</p>';

        try {
            const res = await fetch('/api/products');
            if (!res.ok) throw new Error('Failed: ' + res.status);

            const products = await res.json();
            if (products.length === 0) {
                container.innerHTML = '<p>No products found.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th>';
            html += '</tr></thead><tbody>';

            products.forEach(p => {
                html += `<tr>
                    <td>${p.id || ''}</td>
                    <td>${p.name || ''}</td>
                    <td>${p.category || '-'}</td>
                    <td>$${Number(p.price).toFixed(2)}</td>
                    <td>${p.stock ?? '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            console.error(e);
        } finally {
            button.disabled = false;
            button.textContent = 'Load Products';
        }
    }
    
    // FIX: Changed method to 'PUT' after PATCH and POST failed with 405
    async function updatePrice() {
        const id = document.getElementById('updateId').value.trim();
        const newPrice = document.getElementById('newPrice').value.trim();

        if (!id || !newPrice) {
            alert('Please enter both Product ID and the New Price.');
            return;
        }
        
        const priceValue = parseFloat(newPrice);
        if (isNaN(priceValue) || priceValue < 0) {
            alert('Please enter a valid price.');
            return;
        }

        const productUpdate = { price: priceValue }; 

        if (!confirm(`Update price for product ID ${id} to $${priceValue.toFixed(2)}?`)) return;

        try {
            const res = await fetch(`/api/products/${id}`, {
                method: 'PUT', // Now using PUT
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productUpdate)
            });

            if (res.status === 404) return alert('Product not found!');
            if (!res.ok) throw new Error(await res.text() || res.status);

            alert('Price updated successfully!');
            document.getElementById('updateId').value = '';
            document.getElementById('newPrice').value = '';

            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }
        } catch (err) {
            alert('Error updating price: ' + err.message);
            console.error(err);
        }
    }


    async function addProduct() {
        const name = document.getElementById('addName').value.trim();
        const price = document.getElementById('addPrice').value.trim();
        const category = document.getElementById('addCategory').value.trim();
        const stock = document.getElementById('addStock').value.trim();

        if (!name || !price) return alert('Name and Price are required!');

        const product = {
            name,
            price: parseFloat(price),
            category: category || null,
            stock: stock ? parseInt(stock, 10) : null
        };

        try {
            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            });

            if (!res.ok) throw new Error(await res.text());

            alert('Product added successfully!');
            document.getElementById('addName').value = '';
            document.getElementById('addPrice').value = '';
            document.getElementById('addCategory').value = '';
            document.getElementById('addStock').value = '';

            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    async function deleteProduct() {
        const id = document.getElementById('deleteId').value.trim();
        if (!id) return alert('Enter ID');
        if (!confirm(`Delete product ID ${id}?`)) return;

        try {
            const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text() || res.status);

            alert('Deleted successfully!');
            document.getElementById('deleteId').value = '';

            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }
        } catch (e) {
            alert('Delete failed: ' + e.message);
        }
    }
    
    async function findProductById() {
        const id = document.getElementById('searchId').value.trim();
        const result = document.getElementById('searchResultId');
        if (!id) return alert('Enter ID');

        result.innerHTML = '<p>Searching...</p>';

        try {
            const res = await fetch(`/api/products/${id}`);
            if (res.status === 404) {
                result.innerHTML = '<p style="color:#999">Product not found</p>';
                return;
            }
            if (!res.ok) throw new Error(await res.text());

            const p = await res.json();

            result.innerHTML = `
                <table><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>${p.id || ''}</td>
                            <td>${p.name || ''}</td>
                            <td>${p.category || '-'}</td>
                            <td>$${Number(p.price).toFixed(2)}</td>
                            <td>${p.stock ?? '-'}</td>
                            <td><button onclick="editProductFull(${p.id})">Edit</button></td>
                        </tr>
                    </tbody>
                </table>
            `;
        } catch (e) {
            result.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            console.error(e);
        }
    }
    
    async function editProductFull(productId) {
        try {
            const res = await fetch(`/api/products/${productId}`);
            if (!res.ok) {
                if (res.status === 404) return alert('Product not found!');
                throw new Error('Server error');
            }

            const product = await res.json();

            document.getElementById('editProductId').value       = product.id;
            document.getElementById('editProductName').value     = product.name || '';
            document.getElementById('editProductPrice').value    = product.price || '';
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductStock').value    = product.stock ?? '';

            document.getElementById('fullUpdateForm').classList.remove('hidden');
            
            document.getElementById('findById').classList.add('hidden');
            
            document.getElementById('editProductName').focus();

        } catch (err) {
            alert('Error loading product for edit: ' + err.message);
            console.error(err);
        }
    }

    async function findProductByName() {
        const name = document.getElementById('searchName').value.trim();
        const result = document.getElementById('searchResultName');
        if (!name) return alert('Enter name');

        result.innerHTML = '<p>Searching...</p>';
        try {
            const res = await fetch(`/api/products/search?name=${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error(await res.text());

            const products = await res.json();
            if (!products.length) return result.innerHTML = '<p>No products found</p>';

            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th></tr></thead><tbody>';
            products.forEach(p => {
                html += `<tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.category || '-'}</td>
                    <td>$${Number(p.price).toFixed(2)}</td>
                    <td>${p.stock ?? '-'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            result.innerHTML = html;
        } catch (e) {
            result.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
        }
    }
    
    async function saveFullProductUpdate() {
        const id       = document.getElementById('editProductId').value;
        const name     = document.getElementById('editProductName').value.trim();
        const price    = document.getElementById('editProductPrice').value.trim();
        const category = document.getElementById('editProductCategory').value.trim();
        const stock    = document.getElementById('editProductStock').value.trim();

        if (!name || !price) {
            alert('Name and Price are required!');
            return;
        }

        if (isNaN(price) || price < 0) {
            alert('Please enter a valid price');
            return;
        }

        const updatedProduct = {
            name,
            price: parseFloat(price),
            category: category || null,
            stock: stock !== '' ? parseInt(stock, 10) : null
        };

        if (!confirm('Save changes to this product?')) return;

        try {
            const res = await fetch(`/api/products/${id}`, {
                method: 'PUT',                    
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedProduct)
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(errorText || 'Update failed');
            }

            alert('Product updated successfully!');
            cancelFullUpdate();

            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }

        } catch (err) {
            alert('Failed to update: ' + err.message);
            console.error(err);
        }
    }

    function cancelFullUpdate() {
        document.getElementById('fullUpdateForm').classList.add('hidden');
        
        document.getElementById('findById').classList.remove('hidden');

        document.getElementById('editProductId').value = '';
        document.getElementById('editProductName').value = '';
        document.getElementById('editProductPrice').value = '';
        document.getElementById('editProductCategory').value = '';
        document.getElementById('editProductStock').value = '';
    }
</script>
</body>
</html>